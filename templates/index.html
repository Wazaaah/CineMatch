<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch - Movie Recommender</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #141414; color: #fff; min-height: 100vh; }

        /* Header */
        .header {
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 15px 40px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo { color: #E50914; font-size: 1.8rem; font-weight: 700; cursor: pointer; }
        .nav { display: flex; gap: 8px; }
        .nav-item {
            color: #e5e5e5; font-size: 0.85rem; cursor: pointer;
            background: none; border: none; font-family: inherit;
            padding: 8px 14px; border-radius: 4px; transition: all 0.2s;
        }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: #fff; font-weight: 600; background: rgba(229,9,20,0.3); }

        /* Hero */
        .hero {
            height: 75vh; min-height: 550px;
            position: relative;
            display: flex; align-items: flex-end;
            padding: 60px;
        }
        .hero-bg {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; background-position: center top;
            background-color: #1a1a1a;
        }
        .hero-gradient {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to right, rgba(20,20,20,0.95) 0%, rgba(20,20,20,0.4) 60%, transparent 100%),
                        linear-gradient(to top, #141414 0%, transparent 50%);
        }
        .hero-content { position: relative; max-width: 550px; }
        .hero-title { font-size: 3.2rem; font-weight: 700; margin-bottom: 15px; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        .hero-meta { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; font-size: 0.95rem; }
        .hero-rating { color: #46D369; font-weight: 600; }
        .hero-genres { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .hero-genre-tag { background: rgba(255,255,255,0.15); padding: 6px 14px; border-radius: 4px; font-size: 0.85rem; }
        .hero-buttons { display: flex; gap: 12px; }
        .hero-btn {
            padding: 14px 28px; border-radius: 4px; font-size: 1rem; font-weight: 600;
            cursor: pointer; border: none; display: flex; align-items: center; gap: 8px;
        }
        .hero-btn-primary { background: #fff; color: #000; }
        .hero-btn-secondary { background: rgba(109,109,110,0.7); color: #fff; }
        .hero-btn:hover { opacity: 0.85; }

        /* Main */
        .main { padding-top: 70px; }
        .main.with-hero { padding-top: 0; }

        /* Section */
        .section { padding: 25px 40px; }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 8px; }
        .section-subtitle { color: #888; margin-bottom: 20px; font-size: 0.9rem; }

        /* Filters */
        .filters-row {
            display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
            margin-bottom: 20px; padding: 12px 15px;
            background: rgba(255,255,255,0.03); border-radius: 6px;
        }
        .filter-group { display: flex; align-items: center; gap: 6px; }
        .filter-label { font-size: 0.8rem; color: #888; }
        .filter-select, .filter-input {
            background: #333; color: #fff; border: 1px solid #444;
            border-radius: 4px; padding: 8px 10px; font-size: 0.85rem;
        }
        .filter-input { width: 80px; }
        .refresh-btn {
            background: #E50914; color: #fff; border: none; border-radius: 4px;
            padding: 8px 18px; font-size: 0.85rem; cursor: pointer; font-weight: 500;
        }
        .refresh-btn:hover { background: #f40612; }

        /* Movie Row */
        .movie-row { margin-bottom: 35px; }
        .row-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 12px; padding-left: 5px; }
        .row-scroll {
            display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px;
            scrollbar-width: none;
        }
        .row-scroll::-webkit-scrollbar { display: none; }

        /* Movie Grid */
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 15px;
        }

        /* Movie Card */
        .movie-card {
            flex-shrink: 0; width: 170px;
            border-radius: 6px; overflow: hidden; cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            background: #1a1a1a;
        }
        .movie-grid .movie-card { width: auto; }
        .movie-card:hover {
            transform: scale(1.08);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .movie-poster {
            height: 240px;
            background: linear-gradient(135deg, #E50914, #B81D24);
            display: flex; align-items: center; justify-content: center;
            position: relative;
            background-size: cover; background-position: center;
        }
        .movie-poster.has-image { background: #1a1a1a; background-position: top center; }
        .movie-initial {
            font-size: 4rem; font-weight: 700;
            color: rgba(255,255,255,0.8);
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }
        .movie-poster.has-image .movie-initial { display: none; }
        .movie-rating-badge {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0,0.85); color: #FFD700;
            padding: 4px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 600;
        }
        .similarity-badge {
            position: absolute; top: 8px; left: 8px;
            background: #46D369; color: #000;
            padding: 4px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 600;
        }
        .movie-info { padding: 12px; }
        .movie-title {
            font-size: 0.9rem; font-weight: 600; margin-bottom: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .movie-meta { font-size: 0.75rem; color: #888; margin-bottom: 6px; }
        .movie-genres { display: flex; flex-wrap: wrap; gap: 4px; }
        .genre-tag {
            background: rgba(255,255,255,0.1); color: #aaa;
            padding: 2px 6px; border-radius: 3px; font-size: 0.65rem;
        }

        /* Autocomplete */
        .autocomplete-container { position: relative; width: 100%; max-width: 500px; }
        .autocomplete-input {
            width: 100%; padding: 14px 18px; font-size: 1rem;
            background: #252525; border: 2px solid #333;
            border-radius: 8px; color: #fff; outline: none;
        }
        .autocomplete-input:focus { border-color: #E50914; }
        .autocomplete-input::placeholder { color: #666; }
        .autocomplete-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #1a1a1a; border-radius: 0 0 8px 8px;
            max-height: 400px; overflow-y: auto; z-index: 50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; border: 1px solid #333; border-top: none;
        }
        .autocomplete-results.active { display: block; }
        .autocomplete-item {
            display: flex; align-items: center;
            padding: 12px 15px; cursor: pointer;
            border-bottom: 1px solid #252525;
            transition: background 0.15s;
        }
        .autocomplete-item:hover { background: #252525; }
        .autocomplete-poster {
            width: 45px; height: 68px;
            background: linear-gradient(135deg, #E50914, #831010);
            border-radius: 4px; margin-right: 12px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.2rem; color: rgba(255,255,255,0.8);
            background-size: cover; background-position: center; flex-shrink: 0;
        }
        .autocomplete-info { flex-grow: 1; }
        .autocomplete-title { font-weight: 600; margin-bottom: 3px; }
        .autocomplete-meta { font-size: 0.8rem; color: #888; }

        /* Compare */
        .compare-container { display: flex; gap: 20px; align-items: flex-start; }
        .compare-side { flex: 1; }
        .compare-vs {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 30px 15px;
        }
        .compare-vs-text { font-size: 2rem; font-weight: 700; color: #E50914; }
        .compare-movie-card {
            background: #1a1a1a; border-radius: 10px; padding: 20px;
            text-align: center; margin-top: 15px;
        }
        .compare-poster {
            width: 140px; height: 210px; margin: 0 auto 15px;
            background: linear-gradient(135deg, #E50914, #B81D24);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 4rem; font-weight: 700; color: rgba(255,255,255,0.8);
            background-size: cover; background-position: center;
        }
        .compare-result {
            background: #1a1a1a; border-radius: 10px;
            padding: 25px; margin-top: 25px;
        }
        .compare-meter {
            height: 10px; background: #333; border-radius: 5px;
            margin: 12px 0; overflow: hidden;
        }
        .compare-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #E50914, #46D369);
            border-radius: 5px; transition: width 0.6s ease;
        }

        /* Gem Featured */
        .gem-featured {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border-radius: 12px; padding: 30px;
            display: flex; gap: 30px; margin-bottom: 30px;
            border: 1px solid #333;
        }
        .gem-poster {
            width: 180px; height: 270px;
            background: linear-gradient(135deg, #E50914, #B81D24);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 5rem; font-weight: 700; color: rgba(255,255,255,0.8);
            flex-shrink: 0; background-size: cover; background-position: center;
        }
        .gem-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .gem-badge {
            background: linear-gradient(90deg, #FFD700, #FFA500); color: #000;
            padding: 6px 14px; border-radius: 4px;
            font-size: 0.8rem; font-weight: 700;
            display: inline-block; margin-bottom: 15px; width: fit-content;
        }
        .gem-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
        .gem-meta { color: #888; margin-bottom: 12px; }
        .gem-buttons { display: flex; gap: 10px; }
        .gem-btn {
            background: #E50914; color: #fff; border: none;
            padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: 600;
        }
        .gem-btn.secondary { background: #333; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; align-items: flex-start; justify-content: center;
            padding: 30px; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #181818; border-radius: 10px;
            max-width: 900px; width: 100%; position: relative; margin: auto;
        }
        .modal-close {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0,0,0,0.6); border: none; color: #fff;
            width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; font-size: 1.2rem; z-index: 10;
        }
        .modal-close:hover { background: rgba(0,0,0,0.8); }
        .modal-hero {
            height: 380px;
            background: linear-gradient(135deg, #E50914, #B81D24);
            position: relative;
            background-size: cover; background-position: center top;
        }
        .modal-hero::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0;
            height: 180px; background: linear-gradient(transparent, #181818);
        }
        .modal-hero-initial {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10rem; font-weight: 700; color: rgba(255,255,255,0.5);
        }
        .modal-hero.has-image .modal-hero-initial { display: none; }
        .modal-content { padding: 25px 30px; margin-top: -100px; position: relative; }
        .modal-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
        .modal-meta {
            display: flex; align-items: center; gap: 15px;
            margin-bottom: 15px; color: #888; font-size: 0.95rem;
        }
        .modal-year { color: #46D369; font-weight: 600; }
        .modal-genres-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .modal-genre-tag {
            background: rgba(255,255,255,0.1); color: #fff;
            padding: 6px 14px; border-radius: 20px; font-size: 0.85rem;
        }

        /* RATINGS GRID - 3 cards (Actual + 2 Models) */
        .ratings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);  /* Changed from 4 to 3 */
            gap: 12px;
            margin-bottom: 25px;
        }
        .rating-card {
            background: #252525; padding: 15px;
            border-radius: 8px; text-align: center;
        }
        .rating-card.actual { border: 2px solid #FFD700; background: rgba(255,215,0,0.1); }
        .rating-card.gb { border: 2px solid #46D369; background: rgba(70,211,105,0.1); }
        .rating-card.ridge { border: 2px solid #9B59B6; background: rgba(155, 89, 182, 0.1); }
        .rating-label { font-size: 0.7rem; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .rating-value { font-size: 1.6rem; font-weight: 700; }
        .rating-card.actual .rating-value { color: #FFD700; }
        .rating-card.gb .rating-value { color: #46D369; }
        .rating-card.xgboost .rating-value { color: #9B59B6; }
        .rating-card.ridge .rating-value { color: #9B59B6; }
        .rating-sub { font-size: 0.65rem; color: #666; margin-top: 4px; }
        .rating-rmse { font-size: 0.6rem; color: #555; margin-top: 2px; }

        .similar-section { border-top: 1px solid #333; padding-top: 25px; }
        .similar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .similar-title { font-size: 1.2rem; font-weight: 600; }
        .method-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 4px; font-weight: 600; }
        .method-badge.features { background: #46D369; color: #000; }
        .method-badge.genre { background: #FFA500; color: #000; }
        .similar-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 5px; }
        .similar-scroll::-webkit-scrollbar { display: none; }
        .similar-card { flex-shrink: 0; width: 130px; cursor: pointer; transition: transform 0.2s; }
        .similar-card:hover { transform: scale(1.05); }
        .similar-poster {
            height: 190px; background: linear-gradient(135deg, #333, #1a1a1a);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            position: relative; background-size: cover; background-position: center;
        }
        .similar-poster.has-image .similar-initial { display: none; }
        .similar-initial { font-size: 2.5rem; font-weight: 700; color: rgba(255,255,255,0.4); }
        .similar-info { padding: 10px 3px; }
        .similar-name { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .similar-meta { font-size: 0.75rem; color: #888; }

        /* Utility */
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: #888; }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333;
            border-top-color: #E50914; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .no-results { text-align: center; padding: 60px; color: #666; font-size: 1.1rem; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .tmdb-attr { position: fixed; bottom: 10px; right: 15px; font-size: 0.7rem; color: #444; }

        /* Model legend */
        .model-legend {
            display: flex; gap: 20px; margin-bottom: 15px; padding: 10px 15px;
            background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.8rem;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.gb { background: #46D369; }
        .legend-dot.ridge { background: #9B59B6; }

        @media (max-width: 768px) {
            .ratings-grid { grid-template-columns: repeat(1, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <span class="logo" onclick="showSection('trending')">üé¨ CineMatch</span>
        <nav class="nav">
            <button class="nav-item active" data-section="trending" onclick="showSection('trending')">üî• Trending</button>
            <button class="nav-item" data-section="search" onclick="showSection('search')">üîç Search</button>
            <button class="nav-item" data-section="similar" onclick="showSection('similar')">üé≠ Find Similar</button>
            <button class="nav-item" data-section="compare" onclick="showSection('compare')">‚öñÔ∏è Compare</button>
            <button class="nav-item" data-section="gems" onclick="showSection('gems')">üíé Hidden Gems</button>
            <button class="nav-item" data-section="genres" onclick="showSection('genres')">üé¨ Genres</button>
        </nav>
    </header>

    <main class="main with-hero">
        <!-- TRENDING -->
        <div id="section-trending" class="page-section active">
            <div class="hero" id="hero-banner">
                <div class="hero-bg" id="hero-bg"></div>
                <div class="hero-gradient"></div>
                <div class="hero-content">
                    <h1 class="hero-title" id="hero-title">Loading...</h1>
                    <div class="hero-meta">
                        <span class="hero-rating" id="hero-rating"></span>
                        <span id="hero-votes"></span>
                    </div>
                    <div class="hero-genres" id="hero-genres"></div>
                    <div class="hero-buttons">
                        <button class="hero-btn hero-btn-primary" id="hero-play-btn">‚ñ∂ View Details</button>
                        <button class="hero-btn hero-btn-secondary" onclick="loadFeatured()">‚ü≥ Shuffle</button>
                    </div>
                </div>
            </div>
            <div id="genre-rows"></div>
        </div>

        <!-- SEARCH -->
        <div id="section-search" class="page-section">
            <div class="section">
                <h2 class="section-title">üîç Search Movies</h2>
                <p class="section-subtitle">Find any movie and see predictions from 3 ML models</p>
                <div class="autocomplete-container" style="max-width:600px;">
                    <input type="text" id="search-input" class="autocomplete-input"
                           placeholder="Type a movie name..." autocomplete="off">
                    <div id="search-results" class="autocomplete-results"></div>
                </div>
                <div id="search-grid" class="movie-grid" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- SIMILAR -->
        <div id="section-similar" class="page-section">
            <div class="section">
                <h2 class="section-title">üé≠ Find Similar Movies</h2>
                <p class="section-subtitle">ML-powered similarity using enhanced features</p>
                <div class="autocomplete-container" style="max-width:600px;">
                    <input type="text" id="similar-input" class="autocomplete-input"
                           placeholder="Type a movie name..." autocomplete="off">
                    <div id="similar-results" class="autocomplete-results"></div>
                </div>
                <div id="similar-output" style="margin-top:30px;"></div>
            </div>
        </div>

        <!-- COMPARE -->
        <div id="section-compare" class="page-section">
            <div class="section">
                <h2 class="section-title">‚öñÔ∏è Compare Two Movies</h2>
                <p class="section-subtitle">See ML predictions and similarity analysis</p>
                <div class="compare-container">
                    <div class="compare-side">
                        <div class="autocomplete-container">
                            <input type="text" id="compare-input-1" class="autocomplete-input"
                                   placeholder="First movie..." autocomplete="off">
                            <div id="compare-results-1" class="autocomplete-results"></div>
                        </div>
                        <div id="compare-movie-1"></div>
                    </div>
                    <div class="compare-vs"><span class="compare-vs-text">VS</span></div>
                    <div class="compare-side">
                        <div class="autocomplete-container">
                            <input type="text" id="compare-input-2" class="autocomplete-input"
                                   placeholder="Second movie..." autocomplete="off">
                            <div id="compare-results-2" class="autocomplete-results"></div>
                        </div>
                        <div id="compare-movie-2"></div>
                    </div>
                </div>
                <div id="compare-output"></div>
            </div>
        </div>

        <!-- GEMS -->
        <div id="section-gems" class="page-section">
            <div class="section">
                <h2 class="section-title">üíé Hidden Gems</h2>
                <p class="section-subtitle">Highly-rated movies with low visibility</p>
                <div id="featured-gem"></div>
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Votes:</label>
                        <input type="number" id="gems-min-votes" class="filter-input" value="100">
                        <span style="color:#666">-</span>
                        <input type="number" id="gems-max-votes" class="filter-input" value="1000">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Min Rating:</label>
                        <input type="number" id="gems-min-score" class="filter-input" value="4.0" step="0.1">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort:</label>
                        <select id="gems-sort" class="filter-select">
                            <option value="rating">Highest Rated</option>
                            <option value="az">A-Z</option>
                            <option value="newest">Newest</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="loadGems()">üîÑ Refresh</button>
                </div>
                <div id="gems-grid" class="movie-grid"></div>
            </div>
        </div>

        <!-- GENRES -->
        <div id="section-genres" class="page-section">
            <div class="section">
                <h2 class="section-title">üé¨ Browse by Genre</h2>
                <p class="section-subtitle">Explore top-rated movies by genre</p>
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Genre:</label>
                        <select id="genre-select" class="filter-select" onchange="loadGenreMovies()">
                            <option value="">Select a genre...</option>
                            {% for genre in genres %}
                            <option value="{{ genre }}">{{ genre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort:</label>
                        <select id="genre-sort" class="filter-select" onchange="loadGenreMovies()">
                            <option value="rating">Highest Rated</option>
                            <option value="az">A-Z</option>
                            <option value="newest">Newest</option>
                        </select>
                    </div>
                </div>
                <div id="genre-grid" class="movie-grid"></div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="movie-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <div class="tmdb-attr">Poster images from TMDB</div>

    <script>
        const TMDB_API_KEY = "{{ tmdb_api_key }}";
        const TMDB_BASE = 'https://image.tmdb.org/t/p';

        // Image loader
        async function loadImages() {
            const elements = document.querySelectorAll('[data-tmdb-id]:not(.loaded), [data-imdb-id]:not(.loaded)');
            for (let el of elements) {
                el.classList.add('loaded');
                const tmdbId = el.getAttribute('data-tmdb-id');
                const imdbId = el.getAttribute('data-imdb-id');
                const isHero = el.classList.contains('hero-bg') || el.classList.contains('modal-hero');
                let url = '';
                try {
                    if (tmdbId && tmdbId !== 'null' && TMDB_API_KEY) {
                        const res = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}`);
                        const item = await res.json();
                        const path = isHero ? item.backdrop_path : item.poster_path;
                        if (path) url = `${TMDB_BASE}/${isHero ? 'original' : 'w342'}${path}`;
                    }
                    if (!url && imdbId && imdbId !== 'null') {
                        const res = await fetch(`/api/imdb-poster/${imdbId}`);
                        const data = await res.json();
                        if (data.poster) url = data.poster;
                    }
                    if (url) {
                        el.style.backgroundImage = `url('${url}')`;
                        el.classList.add('has-image');
                        el.querySelector('.movie-initial')?.remove();
                    }
                } catch (e) { console.error('Image load error', e); }
            }
        }

        // Create card
        function createCard(m, showSim=false) {
            const r = m.avgRating || m.weightedScore;
            return `
                <div class="movie-card" onclick="openMovie(${m.movieId})">
                    <div class="movie-poster" data-tmdb-id="${m.tmdbId}" data-imdb-id="${m.imdbId}">
                        <span class="movie-initial">${m.cleanTitle?.[0] || '?'}</span>
                        ${r ? `<div class="movie-rating-badge">‚òÖ ${r.toFixed(1)}</div>` : ''}
                        ${showSim && m.similarity ? `<div class="similarity-badge">${m.similarity}%</div>` : ''}
                    </div>
                    <div class="movie-info">
                        <div class="movie-title" title="${m.cleanTitle}">${m.cleanTitle}</div>
                        <div class="movie-meta">${m.year || ''} ${m.numRatings ? '‚Ä¢ '+m.numRatings.toLocaleString()+' votes' : ''}</div>
                        <div class="movie-genres">${m.genres.slice(0,2).map(g=>`<span class="genre-tag">${g}</span>`).join('')}</div>
                    </div>
                </div>`;
        }

        // Render predictions (3 cards: Actual + GradientBoost + Ridge)
        function renderPredictions(avgRating, predictions) {
            const gb = predictions?.gradientBoost;
            const ridge = predictions?.ridge;


            return `
                <div class="model-legend">
                    <div class="legend-item"><div class="legend-dot gb"></div>GradientBoost (1st)</div>
                    <div class="legend-item"><div class="legend-dot ridge"></div>Ridge (2nd)</div>

                </div>
                <div class="ratings-grid">
                    <div class="rating-card actual">
                        <div class="rating-label">‚≠ê Actual Rating</div>
                        <div class="rating-value">${avgRating ? avgRating.toFixed(2) : 'N/A'}</div>
                        <div class="rating-sub">User Average</div>
                    </div>
                    <div class="rating-card gb">
                        <div class="rating-label">üèÜ GradientBoost</div>
                        <div class="rating-value">${gb ? gb.toFixed(2) : 'N/A'}</div>
                        <div class="rating-sub">1st Place</div>
                        <div class="rating-rmse">RMSE: 0.8544</div>
                    </div>
                    <div class="rating-card ridge">
                        <div class="rating-label">ü•à Ridge</div>
                        <div class="rating-value">${ridge ? ridge.toFixed(2) : 'N/A'}</div>
                        <div class="rating-sub">2nd Place</div>
                    </div>
                </div>`;
        }

        // Page switching
        function showSection(s) {
            document.querySelectorAll('.page-section').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById('section-'+s).classList.add('active');
            document.querySelector(`[data-section="${s}"]`)?.classList.add('active');
            document.querySelector('.main').classList.toggle('with-hero', s==='trending');

            if (s==='trending') { loadFeatured(); loadGenreRows(); }
            else if (s==='gems') { loadRandomGem(); loadGems(); }
            else if (s==='search') { loadRandomMovies(); }
        }

        async function loadRandomMovies() {
            const grid = document.getElementById('search-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const r = await fetch('/api/trending?sort=random&limit=30');
                const movies = await r.json();
                grid.innerHTML = movies.length ? movies.map(m => createCard(m)).join('') : '<div class="no-results">No movies</div>';
                loadImages();
            } catch(e) { grid.innerHTML = '<div class="no-results">Error</div>'; }
        }

        async function loadFeatured() {
            try {
                const r = await fetch('/api/featured');
                const m = await r.json();
                document.getElementById('hero-title').textContent = m.cleanTitle;
                document.getElementById('hero-rating').textContent = m.avgRating ? `‚òÖ ${m.avgRating.toFixed(1)}` : '';
                document.getElementById('hero-votes').textContent = m.numRatings ? m.numRatings.toLocaleString()+' votes' : '';
                document.getElementById('hero-genres').innerHTML = m.genres.slice(0,4).map(g=>`<span class="hero-genre-tag">${g}</span>`).join('');
                const heroBg = document.getElementById('hero-bg');
                heroBg.setAttribute('data-tmdb-id', m.tmdbId);
                heroBg.setAttribute('data-imdb-id', m.imdbId);
                heroBg.classList.remove('loaded');
                loadImages();
                document.getElementById('hero-play-btn').onclick = () => openMovie(m.movieId);
            } catch(e) { console.error(e); }
        }

        async function loadGenreRows() {
            const c = document.getElementById('genre-rows');
            c.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const r = await fetch('/api/genre-rows');
                const rows = await r.json();
                c.innerHTML = rows.map(row => `
                    <div class="section movie-row">
                        <h3 class="row-title">${row.title}</h3>
                        <div class="row-scroll">${row.movies.map(m=>createCard(m)).join('')}</div>
                    </div>`).join('');
                loadImages();
            } catch(e) { c.innerHTML = '<div class="no-results">Error</div>'; }
        }

        async function loadGenreMovies() {
            const genre = document.getElementById('genre-select').value;
            const g = document.getElementById('genre-grid');
            if (!genre) { g.innerHTML = '<div class="no-results">Select a genre</div>'; return; }
            g.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const r = await fetch(`/api/genre/${encodeURIComponent(genre)}?sort=${document.getElementById('genre-sort').value}&limit=30`);
                const m = await r.json();
                g.innerHTML = m.length ? m.map(x => createCard(x)).join('') : '<div class="no-results">No movies</div>';
                loadImages();
            } catch(e) { g.innerHTML = '<div class="no-results">Error</div>'; }
        }

        // Autocomplete
        function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

        function setupAutocomplete(inputId, resultsId, callback) {
            const inp = document.getElementById(inputId);
            const res = document.getElementById(resultsId);

            inp.addEventListener('input', debounce(async () => {
                const q = inp.value.trim();
                if (inputId === 'search-input' && q.length === 0) { res.classList.remove('active'); loadRandomMovies(); return; }
                if (q.length < 2) { res.classList.remove('active'); return; }

                const r = await fetch('/api/autocomplete?q='+encodeURIComponent(q));
                const items = await r.json();
                res.innerHTML = items.map(s => `
                    <div class="autocomplete-item">
                        <div class="autocomplete-poster" data-tmdb-id="${s.tmdbId}" data-imdb-id="${s.imdbId}"></div>
                        <div class="autocomplete-info">
                            <div class="autocomplete-title">${s.cleanTitle}</div>
                            <div class="autocomplete-meta">${s.year || ''} ${s.rating ? '‚Ä¢ ‚òÖ'+s.rating : ''}</div>
                        </div>
                    </div>`).join('');
                res.classList.add('active');
                loadImages();

                res.querySelectorAll('.autocomplete-item').forEach((el, idx) => {
                    el.onclick = () => { inp.value = items[idx].cleanTitle; res.classList.remove('active'); callback(items[idx].movieId); };
                });
            }, 250));

            document.addEventListener('click', (e) => {
                if (!inp.contains(e.target) && !res.contains(e.target)) res.classList.remove('active');
            });
        }

        // Similar
        async function showSimilarFor(movieId) {
            const out = document.getElementById('similar-output');
            out.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const [mRes, sRes] = await Promise.all([fetch('/api/movie/'+movieId), fetch('/api/similar/'+movieId+'?limit=15')]);
                const m = await mRes.json();
                const s = await sRes.json();
                const badge = s.method==='features' ? '<span class="method-badge features">ML Features</span>' : '<span class="method-badge genre">Genre</span>';

                out.innerHTML = `
                    <div style="display:flex;gap:25px;margin-bottom:30px;background:#1a1a1a;padding:25px;border-radius:10px;">
                        <div class="movie-poster" data-tmdb-id="${m.tmdbId}" data-imdb-id="${m.imdbId}"
                             style="width:160px;height:240px;border-radius:8px;flex-shrink:0;"></div>
                        <div style="flex:1;">
                            <h2 style="font-size:1.8rem;margin-bottom:10px;">${m.cleanTitle}</h2>
                            <p style="color:#888;margin-bottom:15px;">${m.year||''} ‚Ä¢ ${m.numRatings?.toLocaleString()||0} votes ‚Ä¢ ${m.genres.join(', ')}</p>
                            ${renderPredictions(m.avgRating, m.predictions)}
                        </div>
                    </div>
                    <div class="similar-header"><h3 class="similar-title">Similar Movies</h3>${badge}</div>
                    <div class="movie-grid">${s.movies.map(x=>createCard(x,true)).join('')}</div>`;
                loadImages();
            } catch(e) { out.innerHTML = '<div class="no-results">Error</div>'; }
        }

        // Gems
        async function loadRandomGem() {
            try {
                const r = await fetch('/api/random-gem');
                const g = await r.json();
                document.getElementById('featured-gem').innerHTML = `
                    <div class="gem-featured">
                        <div class="gem-poster" data-tmdb-id="${g.tmdbId}" data-imdb-id="${g.imdbId}"></div>
                        <div class="gem-info">
                            <span class="gem-badge">üíé HIDDEN GEM</span>
                            <h2 class="gem-title">${g.cleanTitle}</h2>
                            <p class="gem-meta">${g.year||''} ‚Ä¢ ${g.numRatings?.toLocaleString()||0} votes ‚Ä¢ ${g.genres.join(', ')}</p>
                            ${renderPredictions(g.avgRating, g.predictions)}
                            <div class="gem-buttons" style="margin-top:15px;">
                                <button class="gem-btn" onclick="openMovie(${g.movieId})">View Details</button>
                                <button class="gem-btn secondary" onclick="loadRandomGem()">üé≤ Another</button>
                            </div>
                        </div>
                    </div>`;
                loadImages();
            } catch(e) {}
        }

        async function loadGems() {
            const g = document.getElementById('gems-grid');
            g.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            const p = new URLSearchParams({
                min_ratings: document.getElementById('gems-min-votes').value,
                max_ratings: document.getElementById('gems-max-votes').value,
                min_score: document.getElementById('gems-min-score').value,
                sort: document.getElementById('gems-sort').value, limit: 24
            });
            try {
                const r = await fetch('/api/gems?'+p);
                const m = await r.json();
                g.innerHTML = m.length ? m.map(x=>createCard(x)).join('') : '<div class="no-results">No gems</div>';
                loadImages();
            } catch(e) { g.innerHTML = '<div class="no-results">Error</div>'; }
        }

        // Compare
        let cmp = {1:null, 2:null};

        async function selectCompare(side, movieId) {
            cmp[side] = movieId;
            try {
                const r = await fetch('/api/movie/'+movieId);
                const m = await r.json();
                document.getElementById('compare-movie-'+side).innerHTML = `
                    <div class="compare-movie-card">
                        <div class="compare-poster" data-tmdb-id="${m.tmdbId}" data-imdb-id="${m.imdbId}"></div>
                        <div style="font-weight:600;font-size:1.1rem;margin-bottom:5px;">${m.cleanTitle}</div>
                        <div style="color:#888;font-size:0.85rem;margin-bottom:10px;">${m.year||''}</div>
                        <div style="color:#FFD700;margin-bottom:10px;">‚òÖ ${m.avgRating?.toFixed(1)||'N/A'}</div>
                        <div style="font-size:0.75rem;color:#46D369;">GB: ${m.predictions?.gradientBoost?.toFixed(2)||'N/A'}</div>
                        <div style="font-size:0.75rem;color:#FF6B6B;">Ridge: ${m.predictions?.ridge?.toFixed(2)||'N/A'}</div>
                    </div>`;
                loadImages();
                if (cmp[1] && cmp[2]) runCompare();
            } catch(e) { console.error(e); }
        }

        async function runCompare() {
            const out = document.getElementById('compare-output');
            out.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const r = await fetch(`/api/compare?movie1=${cmp[1]}&movie2=${cmp[2]}`);
                const d = await r.json();
                const c = d.comparison;
                out.innerHTML = `
                    <div class="compare-result">
                        <h3 style="text-align:center;margin-bottom:20px;">üìä Similarity Analysis</h3>
                        <div style="margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Genre Similarity</span><span style="color:#46D369;font-weight:600;">${c.genreSimilarity}%</span>
                            </div>
                            <div class="compare-meter"><div class="compare-meter-fill" style="width:${c.genreSimilarity}%"></div></div>
                        </div>
                        ${c.featureSimilarity!==null?`
                        <div style="margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>ML Feature Similarity</span><span style="color:#46D369;font-weight:600;">${c.featureSimilarity}%</span>
                            </div>
                            <div class="compare-meter"><div class="compare-meter-fill" style="width:${c.featureSimilarity}%"></div></div>
                        </div>`:''}
                        <div style="display:flex;gap:15px;margin-top:20px;">
                            <div style="flex:1;"><div style="font-size:0.8rem;color:#888;margin-bottom:8px;">Common Genres</div>
                                ${c.commonGenres.map(g=>`<span class="genre-tag" style="background:#46D369;color:#000;margin:2px;">${g}</span>`).join('')||'<span style="color:#666">None</span>'}
                            </div>
                        </div>
                    </div>`;
            } catch(e) { out.innerHTML = '<div class="no-results">Error</div>'; }
        }

        // Modal
        async function openMovie(id) {
            const modal = document.getElementById('movie-modal');
            const content = document.getElementById('modal-content');
            modal.classList.add('active');
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const [mRes, sRes] = await Promise.all([fetch('/api/movie/'+id), fetch('/api/similar/'+id)]);
                const m = await mRes.json();
                const s = await sRes.json();
                const badge = s.method==='features' ? '<span class="method-badge features">ML Features</span>' : '<span class="method-badge genre">Genre</span>';

                content.innerHTML = `
                    <div class="modal-hero" data-tmdb-id="${m.tmdbId}" data-imdb-id="${m.imdbId}">
                        <span class="modal-hero-initial">${m.cleanTitle?.[0]||'?'}</span>
                    </div>
                    <div class="modal-content">
                        <h1 class="modal-title">${m.cleanTitle}</h1>
                        <div class="modal-meta">
                            <span class="modal-year">${m.year||'N/A'}</span>
                            <span>${m.numRatings?m.numRatings.toLocaleString()+' votes':''}</span>
                        </div>
                        <div class="modal-genres-list">${m.genres.map(g=>`<span class="modal-genre-tag">${g}</span>`).join('')}</div>

                        ${renderPredictions(m.avgRating, m.predictions)}

                        <div class="similar-section">
                            <div class="similar-header"><h3 class="similar-title">Similar Movies</h3>${badge}</div>
                            <div class="similar-scroll">${s.movies.map(x=>`
                                <div class="similar-card" onclick="openMovie(${x.movieId})">
                                    <div class="similar-poster" data-tmdb-id="${x.tmdbId}" data-imdb-id="${x.imdbId}">
                                        <span class="similar-initial">${x.cleanTitle?.[0]||'?'}</span>
                                        ${x.similarity?`<div class="similarity-badge">${x.similarity}%</div>`:''}
                                    </div>
                                    <div class="similar-info">
                                        <div class="similar-name">${x.cleanTitle}</div>
                                        <div class="similar-meta">${x.year||''} ${x.avgRating?'‚Ä¢ ‚òÖ'+x.avgRating.toFixed(1):''}</div>
                                    </div>
                                </div>`).join('')}</div>
                        </div>
                    </div>`;
                loadImages();
            } catch(e) { content.innerHTML = '<div class="no-results">Error</div>'; }
        }

        function closeModal(e) {
            if (!e || e.target===document.getElementById('movie-modal') || e.target.classList.contains('modal-close'))
                document.getElementById('movie-modal').classList.remove('active');
        }

        // Init
        document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });
        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete('search-input', 'search-results', (id) => openMovie(id));
            setupAutocomplete('similar-input', 'similar-results', (id) => showSimilarFor(id));
            setupAutocomplete('compare-input-1', 'compare-results-1', (id) => selectCompare(1, id));
            setupAutocomplete('compare-input-2', 'compare-results-2', (id) => selectCompare(2, id));
            loadFeatured();
            loadGenreRows();
        });
    </script>
</body>
</html>